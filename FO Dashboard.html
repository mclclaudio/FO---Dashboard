<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard de OcorrÃªncias</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
  body {
    font-family: 'Segoe UI', sans-serif;
    background: #f7f9fb;
    color: #222;
    margin: 0;
    padding: 0;
  }
  header {
    background: #fff;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    padding: 15px 25px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  h1 {
    margin: 0;
    font-size: 1.4rem;
  }
  .filters {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    padding: 15px 25px;
    background: #fff;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
  }
  .filters select, .filters input, .filters button {
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 6px;
    font-size: 0.9rem;
  }
  .filters button {
    background: #007bff;
    color: #fff;
    cursor: pointer;
  }
  .filters button:hover {
    background: #0056b3;
  }
  .cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 15px;
    padding: 20px;
  }
  .card {
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.08);
    padding: 15px;
    text-align: center;
  }
  canvas {
    width: 100% !important;
    height: 300px !important;
  }
  #overlay {
    position: fixed;
    top:0; left:0; width:100%; height:100%;
    background: rgba(255,255,255,0.8);
    display:flex; /* Inicia visÃ­vel para mostrar o carregamento inicial */
    justify-content:center;
    align-items:center;
    z-index:1000;
  }
  .spinner {
    border: 6px solid #ddd;
    border-top: 6px solid #007bff;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: spin 1s linear infinite;
  }
  @keyframes spin {
    100% { transform: rotate(360deg); }
  }

  .top-list {
    list-style: none;
    padding: 0;
    margin: 0;
    text-align: left;
  }
  .top-list li {
    display: flex;
    justify-content: space-between;
    padding: 6px 4px;
    border-bottom: 1px solid #f0f0f0;
    font-size: 0.9rem;
  }
  .top-list li:last-child {
    border-bottom: none;
  }
  .top-list li span {
    font-weight: bold;
    background-color: #e9ecef;
    padding: 2px 6px;
    border-radius: 5px;
  }

  .large-cards-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 15px;
    padding: 0 20px 20px 20px;
  }
  .large-card canvas {
    height: 350px !important;
  }

  /* Estilos para o card de MÃ©tricas */
  .metrics-container {
    text-align: left;
    margin-top: 15px;
  }
  .metric-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.9rem;
    padding: 8px 5px;
    border-bottom: 1px solid #eee;
  }
  .metric-item:last-child {
    border-bottom: none;
  }
  .metric-item span {
    color: #555;
  }
  .metric-item strong {
    font-size: 1.1rem;
    color: #007bff;
  }
  .tratativas-divider {
    font-size: 0.8rem;
    font-weight: bold;
    color: #888;
    text-align: center;
    padding: 10px 0 5px 0;
    border-bottom: 1px solid #eee;
    margin-bottom: 5px;
  }

</style>
</head>
<body>

<header>
  <h1>ðŸ“Š Dashboard de OcorrÃªncias</h1>
</header>

<div class="filters">
  <input type="date" id="dataInicio">
  <input type="date" id="dataFim">
  <select id="mesAno"></select>
  <select id="ufFiltro"></select>
  <button id="aplicar">Aplicar Filtros</button>
</div>

<div class="cards">
  <div class="card">
    <h3>MÃ©tricas Gerais</h3>
    <div class="metrics-container">
      <div class="metric-item">
        <span>OcorrÃªncias:</span>
        <strong id="totalOcorrencias">â€“</strong>
      </div>
      <div class="metric-item">
        <span>Clientes Ãšnicos:</span>
        <strong id="totalClientes">â€“</strong>
      </div>
      <div class="metric-item">
        <span>Produtos Ãšnicos:</span>
        <strong id="totalProdutos">â€“</strong>
      </div>
      
      <div class="tratativas-divider">TRATATIVAS</div>

      <div class="metric-item">
        <span>Abatimento:</span>
        <strong id="totalAbatimento">â€“</strong>
      </div>
      <div class="metric-item">
        <span>BonificaÃ§Ã£o:</span>
        <strong id="totalBonificacao">â€“</strong>
      </div>
      <div class="metric-item">
        <span>DevoluÃ§Ã£o:</span>
        <strong id="totalDevolucao">â€“</strong>
      </div>
       <div class="metric-item">
        <span>Sem Retorno:</span>
        <strong id="totalSemRetorno">â€“</strong>
      </div>
    </div>
  </div>

  <div class="card"><h3>Top 5 Produtos</h3><ol id="prodList" class="top-list"></ol></div>
  <div class="card"><h3>Top 5 RegiÃµes (UF)</h3><canvas id="regChart"></canvas></div>
  <div class="card"><h3>Top 5 Clientes</h3><ol id="cliList" class="top-list"></ol></div>
  <div class="card"><h3>Top 5 REPs</h3><ol id="repList" class="top-list"></ol></div>
</div>

<div class="large-cards-container">
  <div class="card large-card"><h3>DistribuiÃ§Ã£o de Tratativas</h3><canvas id="tratChart"></canvas></div>
  <div class="card large-card"><h3>TendÃªncia Temporal (Mensal)</h3><canvas id="trendChart"></canvas></div>
</div>

<div id="overlay"><div class="spinner"></div></div>

<script>
let dataOriginal = [];
let charts = {};
const overlay = document.getElementById("overlay");

const urlCSV = "https://raw.githubusercontent.com/mclclaudio/FO---Dashboard/refs/heads/main/Base-Ocorr%C3%AAncias.csv";

function showOverlay(s) { overlay.style.display = s ? "flex" : "none"; }

document.addEventListener('DOMContentLoaded', () => {
  showOverlay(true);
  Papa.parse(urlCSV, {
    download: true,
    header: true,
    skipEmptyLines: true,
    complete: res => {
      dataOriginal = res.data;
      initFilters();
      atualizarDashboard();
    },
    error: err => {
        console.error("Erro ao baixar ou processar o CSV:", err);
        showOverlay(false);
        alert("NÃ£o foi possÃ­vel carregar os dados do dashboard. Verifique o console para mais detalhes.");
    }
  });
});

function initFilters() {
  const ufFiltro = document.getElementById("ufFiltro");
  ufFiltro.innerHTML = "<option value=''>Todos UF</option>";
  const ufs = [...new Set(dataOriginal.map(r => r.UF).filter(Boolean))];
  ufs.sort().forEach(uf => {
    ufFiltro.innerHTML += `<option value="${uf}">${uf}</option>`;
  });
  const mesAnoSel = document.getElementById("mesAno");
  mesAnoSel.innerHTML = "<option value=''>Todos Meses</option>";
  const meses = [...new Set(dataOriginal.map(r => {
    if (!r.DATA || !r.DATA.includes('/')) return;
    const [d,m,a] = r.DATA.split('/');
    return `${a}-${m}`;
  }).filter(Boolean))];
  meses.sort().reverse().forEach(m => {
    const [a,mm] = m.split("-");
    mesAnoSel.innerHTML += `<option value="${m}">${mm}/${a}</option>`;
  });
}

document.getElementById("aplicar").addEventListener("click", atualizarDashboard);

function atualizarDashboard() {
  showOverlay(true);
  setTimeout(() => {
    let data = [...dataOriginal];
    const inicio = document.getElementById("dataInicio").value;
    const fim = document.getElementById("dataFim").value;
    const mesAno = document.getElementById("mesAno").value;
    const uf = document.getElementById("ufFiltro").value;

    data = data.filter(r => r.DATA && r.DATA.includes("/"));
    data = data.filter(r => {
      const [d,m,a] = r.DATA.split("/");
      if (a.length !== 4) return false;
      const dt = new Date(`${a}-${m}-${d}`);
      let keep = true;
      if (inicio) keep = keep && (dt >= new Date(inicio));
      if (fim) keep = keep && (dt <= new Date(fim));
      if (mesAno) keep = keep && (`${a}-${m}` === mesAno);
      if (uf) keep = keep && (r.UF === uf);
      return keep;
    });

    const totalOcorrencias = data.length;
    const totalClientes = new Set(data.map(r => r.CLIENTE).filter(Boolean)).size;
    const totalProdutos = new Set(data.map(r => r.PRODUTO).filter(Boolean)).size;
    
    // --- CORREÃ‡ÃƒO FINAL: Usando os nomes com acentuaÃ§Ã£o correta ---
    const totalAbatimento = data.filter(r => r.TRATATIVA && r.TRATATIVA.trim().toUpperCase() === "ABATIMENTO").length;
    const totalBonificacao = data.filter(r => r.TRATATIVA && r.TRATATIVA.trim().toUpperCase() === "BONIFICAÃ‡ÃƒO").length;
    const totalDevolucao = data.filter(r => r.TRATATIVA && r.TRATATIVA.trim().toUpperCase() === "DEVOLUÃ‡ÃƒO").length;
    const totalSemRetorno = data.filter(r => r.TRATATIVA && r.TRATATIVA.trim().toUpperCase() === "SEM RETORNO").length;

    // Atualiza os valores no HTML
    document.getElementById("totalOcorrencias").innerText = totalOcorrencias.toLocaleString();
    document.getElementById("totalClientes").innerText = totalClientes.toLocaleString();
    document.getElementById("totalProdutos").innerText = totalProdutos.toLocaleString();
    document.getElementById("totalAbatimento").innerText = totalAbatimento.toLocaleString();
    document.getElementById("totalBonificacao").innerText = totalBonificacao.toLocaleString();
    document.getElementById("totalDevolucao").innerText = totalDevolucao.toLocaleString();
    document.getElementById("totalSemRetorno").innerText = totalSemRetorno.toLocaleString();

    atualizarLista("prodList", contarTop(data, "PRODUTO"));
    atualizarLista("cliList", contarTop(data, "CLIENTE"));
    atualizarLista("repList", contarTop(data, "REP"));
    
    atualizarGrafico("regChart", contarTop(data, "UF"), "Top 5 RegiÃµes");
    atualizarGraficoPizza("tratChart", contarTop(data, "TRATATIVA", 10), "DistribuiÃ§Ã£o de Tratativas");
    atualizarGraficoLinha("trendChart", tendenciaMensal(data), "TendÃªncia Temporal");

    showOverlay(false);
  }, 150);
}

function contarTop(data, campo, limite=5) {
  const cont = {};
  data.forEach(r => {
    const k = r[campo] ? r[campo].trim().toUpperCase() : null; 
    if (k) cont[k] = (cont[k] || 0) + 1;
  });
  const sorted = Object.entries(cont).sort((a,b)=>b[1]-a[1]).slice(0,limite);
  return {labels: sorted.map(e=>e[0]), values: sorted.map(e=>e[1])};
}

function tendenciaMensal(data) {
  const cont = {};
  data.forEach(r=>{
    if (!r.DATA || !r.DATA.includes('/')) return;
    const [d,m,a] = r.DATA.split("/");
    if (a.length !== 4) return;
    const key = `${a}-${m}`;
    cont[key]=(cont[key]||0)+1;
  });
  const arr = Object.entries(cont).sort();
  return {labels: arr.map(e=>e[0].split("-").reverse().join("/")), values: arr.map(e=>e[1])};
}

function atualizarLista(id, {labels, values}) {
  const listElement = document.getElementById(id);
  listElement.innerHTML = ""; 

  if (labels.length === 0) {
    listElement.innerHTML = "<li>Nenhum dado encontrado.</li>";
    return;
  }
  
  for (let i = 0; i < labels.length; i++) {
    const li = document.createElement("li");
    li.innerHTML = `${labels[i]} <span>${values[i]}</span>`;
    listElement.appendChild(li);
  }
}

function atualizarGrafico(id, {labels,values}, label) {
  const ctx = document.getElementById(id).getContext("2d");
  if (!charts[id]) {
    charts[id] = new Chart(ctx, {
      type: "bar",
      data: { labels, datasets: [{ label, data: values, backgroundColor: "#007bff77" }] },
      options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}} }
    });
  } else {
    charts[id].data.labels = labels;
    charts[id].data.datasets[0].data = values;
    charts[id].update();
  }
}

function atualizarGraficoPizza(id, {labels,values}, label) {
  const ctx = document.getElementById(id).getContext("2d");
  if (!charts[id]) {
    charts[id] = new Chart(ctx, {
      type: "pie",
      data: { labels, datasets: [{ label, data: values }] },
      options: { responsive:true, maintainAspectRatio:false }
    });
  } else {
    charts[id].data.labels = labels;
    charts[id].data.datasets[0].data = values;
    charts[id].update();
  }
}

function atualizarGraficoLinha(id, {labels,values}, label) {
  const ctx = document.getElementById(id).getContext("2d");
  if (!charts[id]) {
    charts[id] = new Chart(ctx, {
      type: "line",
      data: { labels, datasets: [{ label, data: values, borderColor:"#007bff", fill:false }] },
      options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}} }
    });
  } else {
    charts[id].data.labels = labels;
    charts[id].data.datasets[0].data = values;
    charts[id].update();
  }
}
</script>

</body>

</html>
