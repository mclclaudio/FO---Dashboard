<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üìä FO Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
/* ===== Estrutura Geral ===== */
body {
  font-family: 'Segoe UI', sans-serif;
  background: #f7f9fb;
  color: #222;
  margin: 0;
  padding: 0;
}

header {
  background: #fff;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  padding: 15px 25px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

h1 {
  margin: 0;
  font-size: 1.4rem;
}

/* ===== Cabe√ßalho com Logo ===== */
.header-content {
  display: flex;
  align-items: center;
  gap: 10px;
  max-height: 60px;
}

.header-content img {
  height: 48px;
  width: auto;
  object-fit: contain;
  border-radius: 8px;
}

.header-content h1 {
  margin: 0;
  font-size: 1.4rem;
  line-height: 1;
}

@media (max-width: 600px) {
  .header-content img { height: 32px; }
  .header-content h1 { font-size: 1.2rem; }
}

/* ===== Abas ===== */
.tabs {
  display: flex;
  justify-content: flex-start;
  gap: 10px;
  background: #fff;
  border-bottom: 1px solid #ddd;
  padding: 10px 25px;
}

.tab {
  padding: 8px 18px;
  font-size: 0.95rem;
  border-radius: 6px;
  border: 1px solid #007bff;
  background-color: #007bff;
  color: #fff;
  cursor: pointer;
  font-weight: 500;
  transition: all 0.25s ease;
}

.tab:hover {
  background-color: #0056b3;
}

.tab.active {
  background-color: #6c757d;
  border-color: #6c757d;
}

.tab-content { display: none; }
.tab-content.active { display: block; }

/* ===== Filtros ===== */
.filters {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  padding: 15px 25px;
  background: #fff;
  box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}

.filters select, .filters input, .filters button {
  padding: 8px;
  border: 1px solid #ccc;
  border-radius: 6px;
  font-size: 0.9rem;
}

.filters button {
  background: #007bff;
  color: #fff;
  cursor: pointer;
  border: none;
}

.filters button:hover { background: #0056b3; }

#limpar { background: #6c757d; }
#limpar:hover { background: #5a6268; }

/* ===== Cards ===== */
.cards {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 15px;
  padding: 20px;
}

.card {
  background: #fff;
  border-radius: 10px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.08);
  padding: 15px;
  text-align: center;
}

canvas {
  width: 100% !important;
  height: 300px !important;
}

/* ===== Gr√°ficos grandes (lado a lado) ===== */
.large-cards-container {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
  gap: 20px;
  padding: 0 20px 20px 20px;
  align-items: stretch;
}

.large-card {
  background: #fff;
  border-radius: 10px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.08);
  padding: 15px;
  text-align: center;
}

/* ===== Overlay de Carregamento ===== */
#overlay {
  position: fixed;
  top:0; left:0; width:100%; height:100%;
  background: rgba(255,255,255,0.8);
  display:flex;
  justify-content:center;
  align-items:center;
  z-index:1000;
}

.spinner {
  border: 6px solid #ddd;
  border-top: 6px solid #007bff;
  border-radius: 50%;
  width: 50px; height: 50px;
  animation: spin 1s linear infinite;
}

@keyframes spin { 100% { transform: rotate(360deg); } }

/* ===== M√©tricas Gerais ===== */
.metrics-container {
  text-align: left;
  margin-top: 15px;
}

.metric-item {
  display: flex;
  justify-content: space-between;
  padding: 8px 5px;
  border-bottom: 1px solid #eee;
  font-size: 0.9rem;
}

.metric-item:last-child { border-bottom: none; }
.metric-item strong { color: #007bff; }

.tratativas-divider {
  text-align: center;
  padding: 10px 0 5px;
  font-weight: bold;
  color: #888;
}

/* ===== TOPs (descri√ß√£o simples + caixa azul nas quantidades) ===== */
.top-list {
  list-style: none;
  padding: 0;
  margin: 0;
  text-align: left;
}

.top-list li {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 6px 8px;
  border-bottom: 1px solid #f0f0f0;
  font-size: 0.9rem;
  font-weight: normal;      /* igual ao das m√©tricas */
  color: #222;              /* cor padr√£o */
}

.top-list li .label {
  flex: 1;
  margin-right: 10px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  max-width: 190px; /* controla largura do texto */
  font-size: 0.70rem;
}

.top-list li span.value {
  background: #007bff22;  /* leve azul transl√∫cido */
  color: #007bff;         /* azul dos n√∫meros */
  font-weight: 600;       /* leve destaque, n√£o negrito pesado */
  padding: 2px 10px;
  border-radius: 5px;
  min-width: 15px;        /* comporta at√© 10.000 */
  text-align: center;
  flex-shrink: 0;
  border: 1px solid #007bff33;
}

/* ===== Ranking ===== */
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 15px;
}

th, td {
  padding: 10px;
  border-bottom: 1px solid #eee;
  text-align: left;
}

th { background: #f1f3f5; }
tr:hover { background: #f9fafb; }

/* ===== Rodap√© (marca d‚Äô√°gua) ===== */
.footer-watermark {
  text-align: right;
  padding: 10px 25px;
  font-size: 1rem;
  font-style: italic;
  color: rgba(0, 0, 0, 0.15);
  margin-top: 40px;
  user-select: none;
  pointer-events: none;
}
</style>
</head>
<body>

<header>
  <div class="header-content">
    <img src="summit.png" alt="Logo FO">
    <h1>Formul√°rio de Ocorr√™ncias</h1>
  </div>
</header>

<!-- Abas -->
<div class="tabs">
  <button class="tab active" data-tab="dashboard">Dashboard</button>
  <button class="tab" data-tab="ranking">Ranking</button>
</div>

<!-- DASHBOARD -->
<div id="dashboard" class="tab-content active">
  <div class="filters">
    <input type="date" id="dataInicio">
    <input type="date" id="dataFim">
    <select id="mesAno"></select>
    <select id="ufFiltro"></select>
    <button id="aplicar">Aplicar Filtros</button>
    <button id="limpar">Limpar Filtros</button>
  </div>

  <div class="cards">
    <div class="card">
      <h3>M√©tricas Gerais</h3>
      <div class="metrics-container">
        <div class="metric-item"><span>Ocorr√™ncias:</span><strong id="totalOcorrencias">‚Äì</strong></div>
        <div class="metric-item"><span>Clientes √önicos:</span><strong id="totalClientes">‚Äì</strong></div>
        <div class="metric-item"><span>Produtos √önicos:</span><strong id="totalProdutos">‚Äì</strong></div>
        <div class="tratativas-divider">TRATATIVAS</div>
        <div class="metric-item"><span>Abatimento:</span><strong id="totalAbatimento">‚Äì</strong></div>
        <div class="metric-item"><span>Bonifica√ß√£o:</span><strong id="totalBonificacao">‚Äì</strong></div>
        <div class="metric-item"><span>Devolu√ß√£o:</span><strong id="totalDevolucao">‚Äì</strong></div>
        <div class="metric-item"><span>Sem Retorno:</span><strong id="totalSemRetorno">‚Äì</strong></div>
      </div>
    </div>

    <div class="card"><h3>Top 5 Produtos</h3><ol id="prodList" class="top-list"></ol></div>
    <div class="card"><h3>Top 5 Regi√µes (UF)</h3><canvas id="regChart"></canvas></div>
    <div class="card"><h3>Top 5 Clientes</h3><ol id="cliList" class="top-list"></ol></div>
    <div class="card"><h3>Top 5 REPs</h3><ol id="repList" class="top-list"></ol></div>
  </div>

  <div class="large-cards-container">
    <div class="card large-card"><h3>Distribui√ß√£o de Tratativas</h3><canvas id="tratChart"></canvas></div>
    <div class="card large-card"><h3>Tend√™ncia Temporal (Mensal)</h3><canvas id="trendChart"></canvas></div>
  </div>
</div>

<!-- RANKING -->
<div id="ranking" class="tab-content">
  <div class="cards">
    <div class="card">
      <h3>Ranking de Produtos (por QTD)</h3>
      <table id="rankingTable">
        <thead>
          <tr><th>C√≥d</th><th>Produto</th><th>QTD Total</th><th>Protocolos</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<div id="overlay"><div class="spinner"></div></div>

<script>
/* === Config === */
const urlCSV = "https://raw.githubusercontent.com/mclclaudio/FO---Dashboard/refs/heads/main/Base-Ocorr%C3%AAncias.csv" + "?nocache=" + Date.now();

/* === Estado === */
let dataOriginal = [];
let charts = {};
const overlay = document.getElementById("overlay");

/* === Utilit√°rios === */
const showOverlay = s => overlay.style.display = s ? "flex" : "none";
const up = s => (s ?? "").toString().trim().toUpperCase();
const deaccent = s => (s ?? "").toString().normalize("NFD").replace(/[\u0300-\u036f]/g,"");
const parseDateBR = s => {
  const p = (s || "").split("/");
  if (p.length < 3) return null;
  const d = Number(p[0]), m = Number(p[1]), y = Number(p[2]);
  const dt = new Date(y, m-1, d);
  return isNaN(dt) ? null : dt;
};
const monthKey = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
const monthLabel = mk => { const [y,m] = mk.split("-"); return `${m}/${y}`; };
const toNum = v => {
  const t = String(v ?? "0").replace(/\./g,"").replace(",",".");
  const n = parseFloat(t);
  return isNaN(n) ? 0 : n;
};

/* === Abas === */
document.querySelectorAll(".tab").forEach(btn=>{
  btn.addEventListener("click",()=>{
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    document.querySelectorAll(".tab-content").forEach(c=>c.classList.remove("active"));
    btn.classList.add("active");
    document.getElementById(btn.dataset.tab).classList.add("active");
  });
});

/* === Carregamento do CSV (robusto) === */
document.addEventListener('DOMContentLoaded',()=>{
  showOverlay(true);
  fetch(urlCSV)
    .then(resp => { if(!resp.ok) throw new Error("HTTP " + resp.status); return resp.text(); })
    .then(text => {
      // Quebra por linhas; remove vazias
      const linhas = text.replace(/\r/g,"").split("\n").filter(l => l.trim().length>0);
      if (linhas.length < 2) throw new Error("CSV vazio ou sem dados.");
      // Cabe√ßalho
      const headers = linhas[0].split(";").map(h => up(h));
      // Linhas -> Objetos
      const dados = linhas.slice(1).map(l => {
        const cols = l.split(";");
        const obj = {};
        headers.forEach((h,i) => obj[h] = (cols[i] ?? "").trim());
        return obj;
      });
      // Normaliza√ß√µes + fallback de COD SEQ
      dataOriginal = dados.map(r => {
        const nr = { ...r };
        if (!nr["COD SEQ"] && nr["DATA"] && nr["BP"]) {
          nr["COD SEQ"] = nr["DATA"].replace(/\D/g,"") + nr["BP"];
        }
        return nr;
      });
      // Init UI
      initFilters();
      atualizarDashboard();
      gerarRanking(); // ranking est√°tico (base total)
    })
    .catch(err => {
      console.error("Falha CSV:", err);
      alert("Falha ao carregar a planilha. Verifique o link e tente novamente.");
    })
    .finally(()=> showOverlay(false));
});

/* === Filtros === */
function initFilters() {
  const ufFiltro = document.getElementById("ufFiltro");
  ufFiltro.innerHTML = "<option value=''>Todos UF</option>";
  [...new Set(dataOriginal.map(r => r["UF"]).filter(Boolean))].sort().forEach(uf => {
    ufFiltro.innerHTML += `<option value="${uf}">${uf}</option>`;
  });

  const mesAnoSel = document.getElementById("mesAno");
  mesAnoSel.innerHTML = "<option value=''>Todos Meses</option>";

  const meses = new Set();
  dataOriginal.forEach(r => {
    const dt = parseDateBR(r["DATA"]);
    if (dt) meses.add(`${dt.getFullYear()}-${String(dt.getMonth() + 1).padStart(2, "0")}`);
  });

  // üîπ Ordenar em ordem crescente (de janeiro a dezembro)
  [...meses].sort().forEach(m => {
    const [a, mm] = m.split("-");
    mesAnoSel.innerHTML += `<option value="${m}">${mm}/${a}</option>`;
  });
}

document.getElementById("aplicar").addEventListener("click", atualizarDashboard);
document.getElementById("limpar").addEventListener("click", ()=>{
  ["dataInicio","dataFim","mesAno","ufFiltro"].forEach(id => document.getElementById(id).value = "");
  atualizarDashboard();
});

/* === Atualiza√ß√£o do Dashboard (com dedup por COD SEQ) === */
function atualizarDashboard(){
  showOverlay(true);
  setTimeout(()=>{
    const inicio = document.getElementById("dataInicio").value;
    const fim    = document.getElementById("dataFim").value;
    const mesAno = document.getElementById("mesAno").value; // YYYY-MM
    const uf     = document.getElementById("ufFiltro").value;

    // Filtra base
    let data = dataOriginal.filter(r => parseDateBR(r["DATA"]));
    data = data.filter(r=>{
      const dt = parseDateBR(r["DATA"]);
      if (!dt) return false;
      if (inicio && dt < new Date(inicio)) return false;
      if (fim) { const to = new Date(fim); to.setHours(23,59,59,999); if (dt > to) return false; }
      if (mesAno && monthKey(dt) !== mesAno) return false;
      if (uf && up(r["UF"]) !== uf) return false;
      return true;
    });

    // Dedup por COD SEQ (casos)
    const uniq = new Map();
    data.forEach(r => {
      const key = up(r["COD SEQ"]);
      if (key && !uniq.has(key)) uniq.set(key, r);
    });
    const casos = [...uniq.values()];

    // ===== M√©tricas (por casos) =====
    const totalOcorrencias = casos.length;
    const totalClientes    = new Set(casos.map(r => up(r["CLIENTE"])).filter(Boolean)).size;
    const totalProdutos    = new Set(casos.map(r => up(r["PRODUTO"])).filter(Boolean)).size;

    const trat = v => up(deaccent(v));
    const totalAbatimento = casos.filter(r => trat(r["TRATATIVA"]) === "ABATIMENTO").length;
    const totalBonificacao = casos.filter(r => trat(r["TRATATIVA"]) === "BONIFICACAO").length;
    const totalDevolucao   = casos.filter(r => trat(r["TRATATIVA"]) === "DEVOLUCAO").length;
    const totalSemRetorno  = casos.filter(r => trat(r["TRATATIVA"]) === "SEM RETORNO").length;

    document.getElementById("totalOcorrencias").innerText = totalOcorrencias.toLocaleString('pt-BR');
    document.getElementById("totalClientes").innerText    = totalClientes.toLocaleString('pt-BR');
    document.getElementById("totalProdutos").innerText    = totalProdutos.toLocaleString('pt-BR');
    document.getElementById("totalAbatimento").innerText  = totalAbatimento.toLocaleString('pt-BR');
    document.getElementById("totalBonificacao").innerText = totalBonificacao.toLocaleString('pt-BR');
    document.getElementById("totalDevolucao").innerText   = totalDevolucao.toLocaleString('pt-BR');
    document.getElementById("totalSemRetorno").innerText  = totalSemRetorno.toLocaleString('pt-BR');

    // ===== Tops =====
    // Produtos (soma QTD na base FILTRADA original, sem dedup)
    atualizarLista("prodList", contarTopQtd(data, "PRODUTO", "QTD"));
    // Os demais, com base em casos (dedup por protocolo)
    atualizarLista("cliList", contarTop(casos, "CLIENTE"));
    atualizarLista("repList", contarTop(casos, "REP"));
    atualizarGrafico("regChart", contarTop(casos, "UF"), "Top 5 Regi√µes");

    // ===== Gr√°ficos =====
    atualizarGraficoPizza("tratChart", contarTop(casos, "TRATATIVA", 10), "Distribui√ß√£o de Tratativas");
    atualizarGraficoLinha("trendChart", tendenciaMensal(casos), "Tend√™ncia Temporal");

    showOverlay(false);
  }, 100);
}

/* === Agrega√ß√µes === */
function contarTop(data, campo, limite=5){
  const cont = {};
  data.forEach(r=>{
    const k = up(r[campo]);
    if (k) cont[k] = (cont[k]||0) + 1;
  });
  const sorted = Object.entries(cont).sort((a,b)=>b[1]-a[1]).slice(0,limite);
  return { labels: sorted.map(e=>e[0]), values: sorted.map(e=>e[1]) };
}

function contarTopQtd(data, campo, campoQtd, limite=5){
  const cont = {};
  data.forEach(r=>{
    const k = up(r[campo]);
    const q = toNum(r[campoQtd]);
    if (k) cont[k] = (cont[k]||0) + q;
  });
  const sorted = Object.entries(cont).sort((a,b)=>b[1]-a[1]).slice(0,limite);
  return { labels: sorted.map(e=>e[0]), values: sorted.map(e=>e[1]) };
}

function tendenciaMensal(data){
  const cont = {};
  data.forEach(r=>{
    const dt = parseDateBR(r["DATA"]);
    if (!dt) return;
    const k = monthKey(dt);
    cont[k] = (cont[k]||0) + 1;
  });
  const arr = Object.entries(cont).sort((a,b)=> a[0].localeCompare(b[0]));
  return { labels: arr.map(([k])=> monthLabel(k)), values: arr.map(([k,v])=> v) };
}

/* === Render Helpers === */
function atualizarLista(id, { labels, values }) {
  const el = document.getElementById(id);
  el.innerHTML = "";
  labels.forEach((l, i) => {
    const texto = l.length > 21 ? l.substring(0, 21) + "‚Ä¶" : l;
    el.innerHTML += `
      <li>
        <span class="label">${texto}</span>
        <span class="value">${values[i].toLocaleString("pt-BR")}</span>
      </li>`;
  });
}

function atualizarGrafico(id,{labels,values},label){
  const ctx = document.getElementById(id).getContext("2d");
  if(!charts[id]){
    charts[id] = new Chart(ctx,{
      type:"bar",
      data:{ labels, datasets:[{ label, data:values, backgroundColor:"#007bff77" }] },
      options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:false } } }
    });
  } else {
    charts[id].data.labels = labels;
    charts[id].data.datasets[0].data = values;
    charts[id].update();
  }
}

function atualizarGraficoPizza(id,{labels,values},label){
  const ctx = document.getElementById(id).getContext("2d");
  if(!charts[id]){
    charts[id] = new Chart(ctx,{
      type:"pie",
      data:{ labels, datasets:[{ label, data:values }] },
      options:{ responsive:true, maintainAspectRatio:false }
    });
  } else {
    charts[id].data.labels = labels;
    charts[id].data.datasets[0].data = values;
    charts[id].update();
  }
}

function atualizarGraficoLinha(id,{labels,values},label){
  const ctx = document.getElementById(id).getContext("2d");
  if(!charts[id]){
    charts[id] = new Chart(ctx,{
      type:"line",
      data:{ labels, datasets:[{ label, data:values, borderColor:"#007bff", fill:false }] },
      options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:false } } }
    });
  } else {
    charts[id].data.labels = labels;
    charts[id].data.datasets[0].data = values;
    charts[id].update();
  }
}

/* === Ranking est√°tico (Top 20 por QTD total, com protocolos √∫nicos) === */
function gerarRanking(){
  const produtos = {};
  const protocolosPorProduto = {};
  dataOriginal.forEach(r=>{
    const prod = up(r["PRODUTO"]);
    const cod  = up(r["C√ìDIGO"]);
    const qtd  = toNum(r["QTD"]);
    if (!prod) return;
    const key = `${cod}|${prod}`;
    produtos[key] = (produtos[key] || 0) + qtd;
    const seq = up(r["COD SEQ"]);
    if (!protocolosPorProduto[key]) protocolosPorProduto[key] = new Set();
    if (seq) protocolosPorProduto[key].add(seq);
  });

  const ranking = Object.entries(produtos)
    .map(([key, qtd])=>{
      const [cod, prod] = key.split("|");
      const protocolos = protocolosPorProduto[key] ? protocolosPorProduto[key].size : 0;
      return { cod, prod, qtd, protocolos };
    })
    .sort((a,b)=> b.qtd - a.qtd)
    .slice(0, 20);

  const tbody = document.querySelector("#rankingTable tbody");
  tbody.innerHTML = "";
  ranking.forEach(item=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${item.cod}</td>
      <td>${item.prod}</td>
      <td>${item.qtd.toLocaleString("pt-BR")}</td>
      <td>${item.protocolos}</td>
    `;
    tbody.appendChild(tr);
  });
}

/* Seguran√ßa: se algo quebrar, some com o overlay */
window.addEventListener("error", ()=> { try { showOverlay(false); } catch(_){} });
</script>
<footer class="footer-watermark">
  By Claudio
</footer>
</body>
</html>
